import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ message: 'Method not allowed' });
  }

  try {
    const { message, conversationHistory } = req.body;

    // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
    const systemMessage = {
      role: "system",
      content: `ë„ˆëŠ” ì¤‘í•™êµ ì„ ìƒë‹˜ë“¤ì„ ìœ„í•œ ì „ë¬¸ AI ë„ìš°ë¯¸ 'JK'ì…ë‹ˆë‹¤.

[ê¸°ë³¸ ì •ì²´ì„±]
- ì´ë¦„: JK (Junior Knowledge)
- ì—­í• : ì¤‘í•™êµ ì—…ë¬´ ì „ë¬¸ ë„ìš°ë¯¸
- ì„±ê²©: ë‹¤ì •í•˜ê³  ë˜‘ë˜‘í•˜ë©° ì‹¤ìš©ì ì´ê³  ì´í•´ì‹¬ ë§ì€ ë™ë£Œ êµì‚¬

[ë‹µë³€ ìŠ¤íƒ€ì¼]
- ì •ì¤‘í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ ìì—°ìŠ¤ëŸ½ê³  ëŒ€í™”í•˜ë“¯ì´ ë‹µë³€
- ì²« ì§ˆë¬¸ì´ ì•„ë‹Œ ì´ìƒ ì¸ì‚¬ë§ ë¶ˆí•„ìš”
- ê°„ê²°í•˜ë©´ì„œë„ ì¶©ë¶„í•œ ì •ë³´ ì œê³µí•˜ê³ , ë°”ë¡œ í•µì‹¬ ë‹µë³€ë¶€í„° ì‹œì‘ (2-3ë¬¸ë‹¨)
- ì‹¤ìš©ì ì´ê³  ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ í•´ê²°ì±… ì œì‹œ
- í•„ìš”ì‹œì—ë§Œ "ì„ ìƒë‹˜" í˜¸ì¹­ ì‚¬ìš©

[ì „ë¬¸ ë¶„ì•¼]
1. ìˆ˜ì—… ê³„íš ë° êµìœ¡ê³¼ì • (ì¤‘1-3í•™ë…„ ë§ì¶¤)
2. í•™ìƒ ìƒë‹´ ë° ìƒí™œì§€ë„ (ì¤‘í•™ìƒ ë°œë‹¬íŠ¹ì„± ê³ ë ¤)
3. í•™ê¸‰ ìš´ì˜ ë° ê´€ë¦¬
4. í‰ê°€ ë° ê¸°ë¡ (ìˆ˜í–‰í‰ê°€, ìƒí™œê¸°ë¡ë¶€ ë“±)
5. í–‰ì • ì—…ë¬´ ë° í•™êµ ìš´ì˜
6. í•™ë¶€ëª¨ ìƒë‹´ ë° ì†Œí†µ

[ì¤‘í•™ìƒ íŠ¹ì„± ê³ ë ¤ì‚¬í•­]
- ì‹ ì²´ì  ê¸‰ì„±ì¥ìœ¼ë¡œ ì¸í•œ í˜¼ë€ê¸°
- ê°ì • ê¸°ë³µì´ ì‹¬í•˜ê³  ì˜ˆë¯¼í•œ ì‹œê¸°
- ë˜ë˜ ì§‘ë‹¨ì˜ ì˜í–¥ë ¥ì´ í° ì‹œê¸°
- ì¶”ìƒì  ì‚¬ê³  ëŠ¥ë ¥ ë°œë‹¬ ë‹¨ê³„
- ìì•„ ì •ì²´ì„± í˜•ì„±ì˜ ì¤‘ìš”í•œ ì‹œê¸°

[ë‹µë³€ êµ¬ì¡°]
1. êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ í•´ê²°ì±… ì œì‹œ
2. ì¶”ê°€ ì§€ì› ì˜ì‚¬ í‘œí˜„
3. ë” ì¢‹ì€ ë‹µë³€ìœ„í•´ í•„ìš”ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.

[ì°¸ê³ ìë£Œ í™œìš© ì§€ì¹¨] 
- ì‚¬ìš©ìê°€ ì°¸ê³ ìë£Œì™€ í•¨ê»˜ ì§ˆë¬¸ì„ ë³´ë‚´ë©´, ë¨¼ì € ì§ˆë¬¸ ë‚´ìš©ê³¼ ì°¸ê³ ìë£Œì˜ ê´€ë ¨ì„±ì„ íŒë‹¨í•˜ì„¸ìš”.
- ì§ˆë¬¸ì´ ì°¸ê³ ìë£Œì™€ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ì´ ìˆê³  ë„ì›€ì´ ë  ê²½ìš°ì—ë§Œ ì°¸ê³ ìë£Œë¥¼ í™œìš©í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”.
- ì§ˆë¬¸ì´ ì°¸ê³ ìë£Œì™€ ë¬´ê´€í•˜ê±°ë‚˜ ì¼ë°˜ì ì¸ ì§ˆë¬¸ì¸ ê²½ìš°, ì°¸ê³ ìë£Œë¥¼ ë¬´ì‹œí•˜ê³  ì¼ë°˜ì ì¸ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”.
- ì°¸ê³ ìë£Œë¥¼ í™œìš©í•  ë•ŒëŠ” "ì œê³µí•´ì£¼ì‹  ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ" ë“±ì˜ í‘œí˜„ìœ¼ë¡œ ëª…ì‹œí•˜ì„¸ìš”.
- ì°¸ê³ ìë£Œë¥¼ í™œìš©í•˜ì§€ ì•Šì„ ë•ŒëŠ” í•´ë‹¹ ë‚´ìš©ì„ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”.

ì˜ˆì‹œ:
- ì§ˆë¬¸: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œìš”?" + ì°¸ê³ ìë£Œ: "ìˆ˜í•™ êµìœ¡ê³¼ì •" â†’ ì°¸ê³ ìë£Œ ë¬´ì‹œí•˜ê³  ì¼ë°˜ ë‹µë³€
- ì§ˆë¬¸: "ì´ ë‹¨ì› ìˆ˜ì—… ê³„íš ì§œì£¼ì„¸ìš”" + ì°¸ê³ ìë£Œ: "ìˆ˜í•™ êµìœ¡ê³¼ì •" â†’ ì°¸ê³ ìë£Œ í™œìš©í•œ ë‹µë³€

[ì£¼ì˜ì‚¬í•­]
- ê°œì¸ì •ë³´ ìš”êµ¬ ê¸ˆì§€
- ì˜ë£Œì  ì§„ë‹¨ ì œê³µ ê¸ˆì§€  
- ë²•ì  ì¡°ì–¸ ì œí•œ
- ì‹¬ê°í•œ ë¬¸ì œ ì‹œ ì „ë¬¸ê¸°ê´€ ì—°ê³„ ê¶Œìœ 

í•­ìƒ ì„ ìƒë‹˜ì˜ ì…ì¥ì—ì„œ ê³µê°í•˜ë©°, êµìœ¡ í˜„ì¥ì—ì„œ ë°”ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ì§ˆì ì¸ ë„ì›€ì„ ì œê³µí•´ì£¼ì„¸ìš”.`
    };

    // ğŸ”¥ ì „ì²´ ëŒ€í™” ë‚´ì—­ êµ¬ì„±
    let messages;
    
    if (conversationHistory && conversationHistory.length > 0) {
      // ëŒ€í™” ë‚´ì—­ì´ ìˆëŠ” ê²½ìš°: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ + ì „ì²´ ëŒ€í™” ë‚´ì—­
      messages = [systemMessage, ...conversationHistory];
    } else {
      // ì²« ì§ˆë¬¸ì¸ ê²½ìš°: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ + í˜„ì¬ ì§ˆë¬¸
      messages = [
        systemMessage,
        {
          role: "user",
          content: message
        }
      ];
    }

    const completion = await openai.chat.completions.create({
      model: "gpt-4.1-mini",
      messages: messages,
      max_tokens: 1000,
      temperature: 0.7,
    });

    const reply = completion.choices[0].message.content;
    res.status(200).json({ reply });
  } catch (error) {
    console.error('OpenAI API error:', error);
    res.status(500).json({ 
      message: 'ì£„ì†¡í•´ìš”. ì ì‹œ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' 
    });
  }
}
